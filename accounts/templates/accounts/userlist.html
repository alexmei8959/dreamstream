{% extends 'partials/base.html' %}
{% load static %}
{% block html %}data-layout="vertical" data-layout-style="" data-layout-position="fixed"  data-topbar="light"{% endblock html %}
{% block title %}使用者管理{% endblock title %}

{% block extra_css %}
    <!--datatable css-->
    <link href="{% static 'libs/datatable/css/dataTables.bootstrap5.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'libs/datatable/css/dataTables.dataTables.css' %}" rel="stylesheet"/>

    <!--datatable button css-->
    <link href="{% static 'libs/datatable/css/buttons.dataTables.min.css' %}" rel="stylesheet"/>

    <!--datatable responsive css-->
    <link href="{% static 'libs/datatable/css/responsive.bootstrap.min.css' %}" rel="stylesheet"/>

    <!-- SweetAlert2 css-->
    <link href="{% static 'libs/sweetalert2/dist/sweetalert2.min.css' %}" rel="stylesheet">

    <!-- icon css -->
    <link href="{% static 'iconfonts/fontawesome/fontawesome-all.min.css' %}" rel="stylesheet" type="text/css"/>

    <!-- Select2 css-->
    <link href="{% static 'libs/select2/dist/select2.min.css' %}" rel="stylesheet">

{% endblock extra_css %}

{% block content %}
    <div class="main-content">
        <div class="page-content">
            <div class="container-fluid">
                {% block pagetitle %}
                    {% include "partials/page-title.html" with pagetitle="後台管理" title="使用者管理" %}
                {% endblock pagetitle %}
                <!-- Row -->
                <div class="row row-sm">
                    <div class="col-lg-12">
                        <div class="card custom-card">
                            <div class="card-body">
                                <div>
                                    <button type="button" class="btn btn-primary" id="new" data-bs-toggle="modal"
                                                    data-bs-target="#NewAndEditModal" title="新增"><i class="ri-add-line"></i> 新增</button>
                                    &nbsp
                                    <p></p>
                                </div>
                                <div class="table-responsive ">
                                    <table id="datatable" class="table table-bordered dt-responsive nowrap table-striped align-middle hover" style="width:100%">
                                        <thead>
                                        <tr>
                                            <th scope="col">id</th>
                                            <th scope="col">帳號</th>
                                            <th scope="col">password</th>
                                            <th scope="col">名稱</th>
                                            <th scope="col">電子郵件</th>
                                            <th scope="col">科室別</th>
                                            <th scope="col">啟用否</th>
                                            <th scope="col">最近登入日</th>
                                            <th scope="col">鎖定否</th>
                                            <th scope="col">是否為科室主管</th>
                                            <th scope="col">選單</th>
                                            <th scope="col">動作</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Row -->

                <!-- NEW and EDIT Modal -->
                <div class="modal fade" id="NewAndEditModal" role="dialog">
                    {% csrf_token %}
                    <div class="modal-dialog modal-lg">
                        <!-- Modal content-->
                        <div class="modal-content">
                            <form class="form-group" role="form">
                                <div class="modal-header">
                                    <h3 class="modal-title" id="modal_title"></h3>
                                    <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button">
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="row g-3">
                                        <div class="col-md-6 form-group">
                                            <label for="username">帳號</label><span class="text-danger ml-1" style="color:red"> *</span>
                                            <input type="text" class="form-control" id="username" name="username" placeholder="使用者帳號" required>
                                        </div>
                                        <div class="col-md-6 form-group">
                                            <label for="first_name">名稱</label><span class="text-danger ml-1" style="color:red"> *</span>
                                            <input type="text" class="form-control" id="first_name" name="first_name" placeholder="使用者名稱" required>
                                        </div>
                                        <div class="col-md-12 form-group">
                                            <label for="password">密碼</label><span class="text-danger ml-1" style="color:red"> *</span>
                                            <input type="password" class="form-control" id="password" name="password" placeholder="至少8碼且英數混合" required>
                                        </div>
                                        <div class="col-md-6 form-group">
                                            <label for="email">電子郵件</label>
                                            <input type="email" class="form-control" id="email" name="email" placeholder="電子郵件">
                                        </div>
                                        <div class="col-md-6 form-group">
                                            <label for="department_id">科室別</label>
                                            <select class="form-control form-select" id="department_id" name="department_id">
                                                <option selected value="">選擇科室別</option>
                                                {% for department in objDepartment %}
                                                    <option value="{{ department.id }}">
                                                        {{ department.dept_name }} {% if department.dept_group %} - {{ department.dept_group }}{% endif %}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-6 form-group">
                                            <label for="is_active">是否啟用</label><span class="text-danger ml-1" style="color:red"> *</span>
                                            <select id="is_active" name="is_active" class="form-control form-select" data-bs-placeholder="是否啟用" required>
                                                <option value="1">是</option>
                                                <option value="0">否</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 form-group">
                                            <label for="is_staff">是否為科室主管</label><span class="text-danger ml-1" style="color:red"> *</span>
                                            <select id="is_staff" name="is_staff" class="form-control form-select" data-bs-placeholder="是否為科室主管" required>
                                                <option value="0">否</option>
                                                <option value="1">是</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 form-group">
                                            <label for="menugroup_id">選單群組</label>
                                            <select class="form-control form-select" id="menugroup_id" name="menugroup_id">
                                                <option selected value="">選擇選單群組</option>
                                                {% for menugroup in objMenugroup %}
                                                    <option value="{{ menugroup.id }}">
                                                        {{ menugroup.menu_group }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <input type="hidden" id="user_id" name="user_id" value="">
                                    <input type="hidden" id="type" name="type" value="">
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn ripple btn-primary"><i class="bx bx-save"></i> 存檔</button>
                                    <button class="btn ripple btn-light" data-bs-dismiss="modal" type="button"><i class="ri-close-line"></i> 取消</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            
                <!-- Delete Modal -->
                <div class="modal fade" id="DeleteModal" role="dialog">
                    <div class="modal-dialog">
                        <!-- Modal content-->
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title"><i class="fa fa-trash-alt modal-icon text-danger"> 刪除</i></h4>
                                <small class="modal-subtitle"></small>
                                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                            </div>
                            <div class="modal-body">
                                <p class="lead">你確認要刪除: <strong id="delid"></strong>?</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn ripple btn-danger" data-dismiss="modal" id="delete"><i class="bx bx-trash"></i> 刪除</button>
                                <button type="button" class="btn ripple btn-light" data-bs-dismiss="modal"><i class="ri-close-line"></i> 取消</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Page-content -->
        </div>
    </div>


{% endblock content %}

{% block extra_js %}
    <!-- jquery -->
    <script src="{% static 'libs/jquery/jquery-3.6.0.min.js' %}"></script>

    <!-- Datatable js -->
    <script src="{% static 'libs/datatable/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'libs/datatable/js/dataTables.bootstrap5.min.js' %}"></script>
    <script src="{% static 'libs/datatable/js/dataTables.buttons.min.js' %}"></script>
    <script src="{% static 'libs/datatable/js/dataTables.responsive.min.js' %}"></script>

    <!-- sweetalert2 js-->
    <script src="{% static 'libs/sweetalert2/dist/sweetalert2.all.min.js' %}"></script>
    <script src="{% static 'js/inits/sweetalert2.init.js' %}"></script>

    <!-- select2 js-->
    <script src="{% static 'libs/select2/dist/select2.min.js' %}"></script>
    
    <!-- datatable init -->
    <script>
        let baseUrl = '/accounts/users/';
        // render table
        let table = $('#datatable').DataTable({
            'processing': true,
            'serverSide': true,
            'language': {url: '{% static 'libs/datatable/zh-HANT.json' %}'},
            'ajax': {
                url: baseUrl,
                type: 'GET',
            },
            'columns': [
                {"data": "id"},
                {"data": "username"},
                {"data": "password"},
                {"data": "first_name"},
                {"data": "email"},
                {
                    // Display department name
                    "data": "userstatus",
                    "render": function (data, type, row) {
                        // Check if userstatus array and department exist
                        if (data.length > 0 && data[0].department) {
                            return data[0].department.dept_name;
                        }
                        return ''; // Return empty if no department info
                    }
                },
                {
                    "data": "is_active",
                    "render": function (data, type, row) {
                        return data ? '是' : '否';
                    }
                },
                {"data": "last_login"},
                {
                    "data": "userstatus[0].is_lock",
                    "render": function (data, type, row) {
                        return data === "true" ? "是" : "否";
                    }
                },
                {
                    "data": "is_staff",
                    "render": function (data, type, row) {
                        return data ? '是' : '否';
                    }
                },
                {
                    // Display menugroup name
                    "data": "userstatus",
                    "render": function (data, type, row) {
                        // Check if userstatus array and menugroup exist
                        if (data.length > 0 && data[0].menugroup) {
                            return data[0].menugroup.menu_group;
                        }
                        return ''; // Return empty if no menugroup info
                    }
                },
                {
                    "data": null,
                    "orderable": false,
                    "defaultContent":
                        '<div class="dropdown d-inline-block">' +
                        '<button class="btn btn-soft-secondary btn-sm dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">' +
                        '<i class="ri-more-fill align-middle"></i> ' +
                        '</button> ' +
                        '<ul class="dropdown-menu dropdown-menu-end">' +
                        '<li class="dropdown-item edit-item-btn" data-bs-toggle="modal" data-bs-target="#NewAndEditModal" title="修改"><i class="ri-pencil-fill align-bottom me-2 text-muted"></i> 修改</li> ' +
                        '<li class="dropdown-item remove-item-btn" data-bs-toggle="modal" data-bs-target="#DeleteModal" title="刪除"><i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i> 刪除</li> ' +
                        '</ul>' +
                        '</div>'
                }
            ],
            'columnDefs': [
                //hide column
                {'visible': false, 'targets': [0,2]},
                {'orderable': false, 'targets': [5,8]}
            ],
            'order': [[0, 'desc']],
        });
    </script>

    <!-- CRUD -->
    <script>
        let id = 0;

        $(document).ready(function () {
            // 點選修改或刪除
            $('#datatable tbody').on('click', '.edit-item-btn, .remove-item-btn', function () {
                resetFormValidation();

                let data = table.row($(this).parents('tr')).data();
                if (data === undefined) {
                    let datanum = table.row($(this))['0'][0];
                    data = table.row($(this).parents('tr')).context[0].aoData[datanum]._aData;
                }

                id = data['id'];
                if ($(this).hasClass('edit-item-btn')) {
                    // 修改
                    $('#user_id').val(data['id']);
                    $('#username').val(data['username']);
                    $('#password').val(data['password']);
                    $('#email').val(data['email']);
                    $('#first_name').val(data['first_name']);
                    $('#is_staff').val(data['is_staff'] ? "1" : "0");
                    $('#is_active').val(data['is_active'] ? "1" : "0");
                    $('#department_id').val(data['userstatus'][0]['department']['id']).trigger('change'); // Use .trigger('change') to update Select2 UI
                    $('#menugroup_id').val(data['userstatus'][0]['menugroup']['id']).trigger('change'); // Use .trigger('change') to update Select2 UI
                    $('#type').val('EDIT');
                    $('#modal_title').html('<i class="fas fa-edit modal-icon text-info"> 修改</i>');
                } else {
                    // 刪除
                    $('#delid').text(data['username']);
                }
            });

            // 新增或修改存檔
            $('form').on('submit', function (e) {
                e.preventDefault();
                if (!isValidPassword($('#password').val())) {
                    // Show password validation error
                    $('#password').addClass('is-invalid').parent().append('<div class="text-danger">密碼至少8碼且英數混合</div>');
                    return;
                }

                let url = baseUrl;
                let method = $('#type').val() === 'NEW' ? 'POST' : 'PUT';
                if (method === 'PUT') url += id + '/';

                $.ajax({
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    url: url,
                    method: method,
                    data: $(this).serialize(),
                    success: function () {
                        table.ajax.reload(null, false);
                        $("#NewAndEditModal").modal('hide');
                        Toast.fire({icon: 'success', title: '存檔成功'});
                    },
                    error: function (jqXHR) {
                        let errorMessage = jqXHR.responseJSON;
                        Toast.fire({icon: 'error', title: errorMessage});
                        console.log(jqXHR);
                    }
                });
            });

            // 刪除
            $('#DeleteModal').on('click', '#delete', function () {
                $.ajax({
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    url: baseUrl + id + '/',
                    method: 'DELETE',
                    success: function () {
                        table.ajax.reload(null, false);
                        $("#DeleteModal").modal('hide');
                        Toast.fire({icon: 'success', title: '刪除成功'});
                    },
                    error: function (jqXHR) {
                        Toast.fire({icon: 'error', title: '刪除失敗'});
                        console.log(jqXHR);
                    }
                });
            });

            // 新增
            $('#new').on('click', function () {
                resetFormValidation();
                $('#username, #password, #first_name, #email').val('');
                $('#is_active').val('1');
                $('#is_staff').val('0');
                $('#department_id').val('').trigger('change');
                $('#menugroup_id').val('').trigger('change');
                $('#type').val('NEW');
                $('#modal_title').html('<i class="fa fa-plus modal-icon text-primary"> 新增</i>');
            });

            // 重設
            function resetFormValidation() {
                $('#password').removeClass('is-invalid');
                $('.is-invalid').removeClass('is-invalid');
                $("div.text-danger:contains('密碼至少8碼且英數混合')").remove();
            }
            
            // 密碼驗證
            function isValidPassword(password) {
                // Password must be at least 8 characters long and contain both letters and numbers
                return /^(?=.*[A-Za-z])(?=.*\d).{8,}$/.test(password);
            }
        });

    </script>

    <!-- Select2 -->
    <script>
        $("#department_id").select2({dropdownParent: $('#NewAndEditModal')});
    </script>

{% endblock extra_js %}