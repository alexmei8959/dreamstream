{% extends 'partials/base.html' %}
{% load static %}
{% block title %}群組人員權限管理{% endblock title %}

{% block extra_css %}
    <!--datatable css-->
    <link href="{% static 'libs/datatable/css/dataTables.bootstrap5.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'libs/datatable/css/dataTables.dataTables.css' %}" rel="stylesheet"/>

    <!--datatable button css-->
    <link href="{% static 'libs/datatable/css/buttons.dataTables.min.css' %}" rel="stylesheet"/>

    <!--datatable responsive css-->
    <link href="{% static 'libs/datatable/css/responsive.bootstrap.min.css' %}" rel="stylesheet"/>

    <!-- SweetAlert2 css-->
    <link href="{% static 'libs/sweetalert2/dist/sweetalert2.min.css' %}" rel="stylesheet">

    <!-- icon css -->
    <link href="{% static 'iconfonts/fontawesome/fontawesome-all.min.css' %}" rel="stylesheet" type="text/css"/>

    <!-- Select2 css-->
    <link href="{% static 'libs/select2/dist/select2.min.css' %}" rel="stylesheet">

    <style>
        .table-scrollable-y {
            max-height: 400px; /* 根據需要調整這個高度 */
        }

        .table-responsive,
        .dataTables_scrollBody {
            overflow: visible !important;
        }
        /* 當 table-responsive 和 table-scrollable-y 同時存在時，強制覆蓋 overflow-y */
        .table-responsive.table-scrollable-y {
            overflow-y: auto !important;
        }

        .table-responsive-disabled .dataTables_scrollBody {
            overflow: hidden !important;
        }
    </style>
{% endblock extra_css %}

{% block content %}
    <div class="main-content">
        <div class="page-content">
            <div class="container-fluid">
                {% block pagetitle %}
                    {% include "partials/page-title.html" with title="群組人員權限管理" %}
                {% endblock pagetitle %}
                <!-- Row -->
                <div class="row row-sm">
                    <div class="col-lg-12">
                        <div class="card custom-card">
                            <div class="card-body">
                                <div class="mb-3">
                                    <button type="button" class="btn btn-primary" id="new" data-bs-toggle="modal"
                                            data-bs-target="#NewAndEditModal" title="新增">
                                    </button>
                                </div>
                                <div class="table-responsive ">
                                    <table id="datatable"
                                           class="table table-bordered dt-responsive nowrap table-striped align-middle hover"
                                           style="width:100%">
                                        <thead class="table-head">
                                        <tr>
                                            <th scope="col">序號</th>
                                            <th scope="col">群組名稱</th>
                                            <th scope="col">動作</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Row -->

                <!-- NEW and EDIT Modal -->
                <div class="modal fade" id="NewAndEditModal" role="dialog">
                    {% csrf_token %}
                    <div class="modal-dialog modal-xl">
                        <!-- Modal content-->
                        <div class="modal-content">
                            <form class="form-group" role="form">
                                <div class="modal-header">
                                    <h3 class="modal-title" id="modal_title"></h3>
                                    <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button">
                                    </button>
                                </div>

                                <div class="modal-body">
                                    <div class="row g-3">
                                        <div class="col-md-12 form-group">
                                            <label for="name">群組名稱</label><span class="text-danger ml-1"
                                                                                    style="color:red"> *</span>
                                            <input type="text" class="form-control" id="name" name="name"
                                                   placeholder="群組名稱" required>
                                        </div>
                                        <div class="col-md-6">
                                            <h5>待挑選的權限</h5>
                                            <div class="table-responsive table-scrollable-y">
                                                <table id="left-table" class="table table-bordered">
                                                    <thead>
                                                    <tr>
                                                        <th>app_label</th>
                                                        <th>code_name</th>
                                                        <th>動作</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for permission in Permissions %}
                                                        <tr data-id="{{ permission.id }}"
                                                            data-sort1="{{ permission.id }}">
                                                            <td>{{ permission.content_type.app_label }}</td>
                                                            <td>{{ permission.codename }}</td>
                                                            <td>
                                                                <button type="button"
                                                                        class="btn btn-sm btn-primary move-right">移動
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h5>已挑選的權限</h5>
                                            <div class="table-responsive table-scrollable-y">
                                                <table id="right-table" class="table table-bordered">
                                                    <thead>
                                                    <tr data-id="{{ permission.id }}" data-sort1="{{ permission.id }}">
                                                        <th>app_label</th>
                                                        <th>name</th>
                                                        <th>動作</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    <!-- Initially empty -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="type" name="type" value="">
                                    <div class="modal-footer">
                                        <button type="submit" class="btn ripple btn-primary"><i class="bx bx-save"></i>
                                            存檔
                                        </button>
                                        <button class="btn ripple btn-light" data-bs-dismiss="modal" type="button">
                                            <i
                                                    class="ri-close-line"></i> 取消
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Delete Modal -->
                <div class="modal fade" id="DeleteModal" role="dialog">
                    <div class="modal-dialog">
                        <!-- Modal content-->
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title" id="delete_modal_title"></h4>
                                <small class="modal-subtitle"></small>
                                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal"
                                        type="button"></button>
                            </div>
                            <div class="modal-body">
                                <p class="lead">你確認要刪除: <strong id="delid"></strong>?</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn ripple btn-danger" data-dismiss="modal" id="delete"><i
                                        class="bx bx-trash"></i> 刪除
                                </button>
                                <button type="button" class="btn ripple btn-light" data-bs-dismiss="modal"><i
                                        class="ri-close-line"></i> 取消
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Modal -->
                <div class="modal fade" id="UserModal" role="dialog">
                    {% csrf_token %}
                    <div class="modal-dialog modal-xl">
                        <!-- Modal content-->
                        <div class="modal-content">
                            <form class="form-group" role="form">
                                <div class="modal-header">
                                    <h3 class="modal-title" id="user_modal_title"><i class="fa fa-user modal-icon"></i> 人員</h3>
                                    <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button">
                                    </button>
                                </div>

                                <div class="modal-body">
                                    <div class="row g-3">
                                        <div class="col-md-12 form-group">
                                            <label for="name-user">群組名稱</label><span class="text-danger ml-1"
                                                                                         style="color:red"> *</span>
                                            <input type="text" class="form-control" id="name-user" name="name"
                                                   placeholder="群組名稱" readonly required>
                                        </div>
                                        <div class="col-md-6">
                                            <h5>待挑選的人員</h5>
                                            <div class="table-responsive table-scrollable-y">
                                                <table id="left-table-user" class="table table-bordered">
                                                    <thead>
                                                    <tr>
                                                        <th>姓名</th>
                                                        <th>email</th>
                                                        <th>動作</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    {% for user in Users %}
                                                        <tr data-id="{{ user.id }}"
                                                            data-sort1="{{ user.id }}">
                                                            <td>{{ user.first_name }}</td>
                                                            <td>{{ user.email }}</td>
                                                            <td>
                                                                <button type="button"
                                                                        class="btn btn-sm btn-primary move-right">移動
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h5>已挑選的人員</h5>
                                            <div class="table-responsive table-scrollable-y">
                                                <table id="right-table-user" class="table table-bordered">
                                                    <thead>
                                                    <tr data-id="{{ user.id }}" data-sort1="{{ user.id }}">
                                                        <th>姓名</th>
                                                        <th>email</th>
                                                        <th>角色</th>
                                                        <th>動作</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    <!-- Initially empty -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="type" name="type" value="">
                                    <div class="modal-footer">
                                        <button type="submit" class="btn ripple btn-primary">
                                            <i class="bx bx-save"></i> 存檔
                                        </button>
                                        <button class="btn ripple btn-light" data-bs-dismiss="modal" type="button">
                                            <i class="ri-close-line"></i> 取消
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
            <!-- End Page-content -->
        </div>
    </div>
{% endblock content %}

{% block extra_js %}

    <!-- jquery -->
    <script src="{% static 'libs/jquery/jquery-3.6.0.min.js' %}"></script>

    <!--  Datatable js -->
    <script src="{% static 'libs/datatable/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'libs/datatable/js/dataTables.bootstrap5.min.js' %}"></script>
    <script src="{% static 'libs/datatable/js/dataTables.buttons.min.js' %}"></script>
    <script src="{% static 'libs/datatable/js/dataTables.responsive.min.js' %}"></script>

    <!-- sweetalert2 js-->
    <script src="{% static 'libs/sweetalert2/dist/sweetalert2.all.min.js' %}"></script>
    <script src="{% static 'js/inits/sweetalert2.init.js' %}"></script>

    <!-- select2 js -->
    <script src="{% static 'libs/select2/dist/select2.min.js' %}"></script>

    <!-- datatable init -->
    <script>
        let baseUrl = '/accounts/group/';

        let table = $('#datatable').DataTable({
            'processing': true,
            'serverSide': true,
            'searching': true,
            'scrollCollapse': true,
            'language': {url: '{% static "libs/datatable/zh-HANT.json" %}'},
            'ajax': {
                url: baseUrl,
                type: 'GET',
            },
            'columns': [
                {"data": "id"},
                {"data": "name"},
                {
                    "data": null,
                    "orderable": false,
                    "defaultContent":
                        '<div class="dropdown d-inline-block">' +
                        '<button class="btn btn-soft-secondary btn-sm dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">' +
                        '<i class="ri-more-fill align-middle"></i> ' +
                        '</button> ' +
                        '<ul class="dropdown-menu dropdown-menu-end">' +
                        '<li class="dropdown-item user-btn" data-bs-toggle="modal" data-bs-target="#UserModal" title="人員"><i class="ri-user-2-fill align-bottom me-2 text-muted"></i> 人員</li> ' +
                        '<li class="dropdown-item edit-item-btn" data-bs-toggle="modal" data-bs-target="#NewAndEditModal" title="權限"><i class="ri-pencil-fill align-bottom me-2 text-muted"></i> 權限</li> ' +
                        '<li class="dropdown-item remove-item-btn" data-bs-toggle="modal" data-bs-target="#DeleteModal" title="刪除"><i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i> 刪除</li> ' +
                        '</ul>' +
                        '</div>'
                }
            ],
        });
    </script>

    <!-- CRUD -->
    <script>
        let id = 0;
        const modal_title = '群組'
        $('#new').html(`<i class="ri-add-line"></i> 新增${modal_title}`)

        $(document).ready(function () {
            // 點選修改或刪除
            $('#datatable tbody').on('click', '.edit-item-btn, .remove-item-btn, .user-btn, .pointer-btn', function () {
                let data = table.row($(this).parents('tr')).data();
                if (data === undefined) {
                    let datanum = table.row($(this))['0'][0];
                    data = table.row($(this).parents('tr')).context[0].aoData[datanum]._aData;
                }
                id = data['id'];

                if ($(this).hasClass('edit-item-btn')) {
                    // 修改
                    $('#name').val(data['name']);
                    $('#type').val('EDIT');
                    $('#modal_title').html(`<i class="fa fa-edit modal-icon text-primary"> 修改${modal_title}</i>`);

                    // 1. 重設左右表格
                    // 清空右邊表格
                    $('#right-table tbody').empty();
                    // 恢復左邊表格為完整的權限列表
                    $('#left-table tbody').html(`
                        {% for permission in Permissions %}
                            <tr data-id="{{ permission.id }}" data-sort1="{{ permission.id }}">
                                <td>{{ permission.content_type.app_label }}</td>
                                <td>{{ permission.codename }}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-primary move-right">移動</button>
                                </td>
                            </tr>
                        {% endfor %}
                    `);

                    // 2. 根據 data.permissions 將權限從左邊移到右邊
                    if (data.permissions && data.permissions.length > 0) {
                        data.permissions.forEach(function (permission) {
                            // 從左邊表格找到對應的權限列，並觸發其移動按鈕的點擊事件
                            $('#left-table tbody tr[data-id="' + permission.id + '"] .move-right').click();
                        });
                    }
                } else if ($(this).hasClass('user-btn')) {
                    // 人員
                    $('#name-user').val(data['name']);

                    // 1. 重設左右表格
                    $('#right-table-user tbody').empty(); // 清空右邊
                    $('#left-table-user tbody').empty();  // 清空左邊

                    // 2. 渲染左邊表格 (所有 Users)
                    {% for user in Users %}
                        $('#left-table-user tbody').append(`
                            <tr data-id="{{ user.id }}" data-sort1="{{ user.id }}">
                                <td>{{ user.first_name }}</td>
                                <td>{{ user.email }}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-primary move-right">移動</button>
                                </td>
                            </tr>
                        `);
                    {% endfor %}

                    // 2. 根據 data.users 將人員從左邊移到右邊
                    if (data.users && data.users.length > 0) {
                        data.users.forEach(function (user) {
                            // 從左邊表格找到對應的人員列，並觸發其移動按鈕的點擊事件
                            $('#left-table-user tbody tr[data-id="' + user.id + '"] .move-right').click();
                        });
                    }
                } else {
                    // 刪除
                    $('#delete_modal_title').html(`<i class="fa fa-trash-alt modal-icon text-danger"> 刪除${modal_title}</i>`);
                    $('#delid').text(data['name']);
                }
            });

            // 新增或修改存檔
            $('#NewAndEditModal form').on('submit', function (e) {
                e.preventDefault();
                let url = baseUrl;
                let method = $('#type').val() === 'NEW' ? 'POST' : 'PUT';
                if (method === 'PUT') url += id + '/';

                // 從 right-table 獲取已挑選的權限 ID
                let permissionIds = $('#right-table tbody tr').map(function () {
                    return $(this).data('id');
                }).get();

                // 將表單數據和權限 ID 組合起來
                let formData = $(this).serialize();
                let dataToSend = formData + '&' + $.param({
                    update_type: "permissions",
                    permissions: permissionIds
                });

                $.ajax({
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    url: url,
                    method: method,
                    data: dataToSend,
                    success: function () {
                        table.ajax.reload(null, false);
                        $("#NewAndEditModal").modal('hide');
                        Toast.fire({icon: 'success', title: '存檔成功'});
                    },
                    error: function (jqXHR) {
                        Toast.fire({icon: 'success', title: '存檔失敗'});
                        console.log(jqXHR);
                    }
                });
            });

            // 刪除
            $('#DeleteModal').on('click', '#delete', function () {
                $.ajax({
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    url: baseUrl + id + '/',
                    method: 'DELETE',
                    success: function () {
                        table.ajax.reload(null, false);
                        $("#DeleteModal").modal('hide');
                        Toast.fire({icon: 'success', title: '刪除成功'});
                    },
                    error: function (jqXHR) {
                        Toast.fire({icon: 'error', title: '刪除失敗'});
                        console.log(jqXHR);
                    }
                });
            });

            // 新增
            $('#new').on('click', function () {
                $('#name').val('');

                // 清空右邊 table
                $('#right-table tbody').empty();
                // 先把左邊恢復原始權限清單
                $('#left-table tbody').html(`
                    {% for permission in Permissions %}
                        <tr data-id="{{ permission.id }}" data-sort1="{{ permission.id }}">
                            <td>{{ permission.content_type.app_label }}</td>
                            <td>{{ permission.codename }}</td>
                            <td><button type="button" class="btn btn-sm btn-primary move-right">移動</button></td>
                        </tr>
                    {% endfor %}
                `);

                $('#type').val('NEW');
                $('#modal_title').html(`<i class="fa fa-plus modal-icon text-primary"> 新增${modal_title}</i>`);
            });

            // UserModal 存檔
            $('#UserModal form').on('submit', function (e) {
                e.preventDefault();
                let url = baseUrl + id + '/';  // 這裡用群組 id
                let method = 'PUT';

                // 從 right-table-user 獲取已挑選的人員 ID
                let userIds = $('#right-table-user tbody tr').map(function () {
                    return $(this).data('id');
                }).get();

                // 原本的 formData (群組名稱等)，人員這裡用 group_users
                let formData = $(this).serialize();
                let dataToSend = formData + '&' + $.param({
                    update_type: "users",
                    group_users: userIds
                });

                $.ajax({
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    url: url,
                    method: method,
                    data: dataToSend,
                    success: function () {
                        table.ajax.reload(null, false);
                        $("#UserModal").modal('hide');
                        Toast.fire({icon: 'success', title: '存檔人員成功'});
                    },
                    error: function (jqXHR) {
                        Toast.fire({icon: 'success', title: '存檔人員失敗'});
                        console.log(jqXHR);
                    }
                });
            });

            // 處理2個table之間的移動及排序
            function sortTable(table) {
                let rows = $(table).find("tbody tr").get();
                rows.sort(function (a, b) {
                    let sort1 = parseInt($(a).data("sort1"));
                    let sort2 = parseInt($(b).data("sort1"));
                    return sort1 - sort2;
                });
                $.each(rows, function (index, row) {
                    $(table).children("tbody").append(row);
                });
            }

            // 權限 Move item to the right
            $('#left-table').on('click', '.move-right', function () {
                let row = $(this).closest('tr');
                row.find('.move-right').removeClass('move-right').addClass('move-left').text('移回');
                $('#right-table tbody').append(row);
                sortTable('#right-table');
            });

            // 權限 Move item to the left
            $('#right-table').on('click', '.move-left', function () {
                let row = $(this).closest('tr');
                row.find('.move-left').removeClass('move-left').addClass('move-right').text('移動');
                $('#left-table tbody').append(row);
                sortTable('#left-table');
            });

            // 人員 Move item to the right
            $('#left-table-user').on('click', '.move-right', function () {
                let row = $(this).closest('tr');
                row.find('.move-right').removeClass('move-right').addClass('move-left').text('移回');
                $('#right-table-user tbody').append(row);
                sortTable('#right-table-user');
            });

            // 人員 Move item to the left
            $('#right-table-user').on('click', '.move-left', function () {
                let row = $(this).closest('tr');
                row.find('.move-left').removeClass('move-left').addClass('move-right').text('移動');
                $('#left-table-user tbody').append(row);
                sortTable('#left-table-user');
            });

        });
    </script>

{% endblock extra_js %}