{% extends 'partials/base.html' %}
{% load static %}
{% block html %}data-layout="vertical" data-layout-style="" data-layout-position="fixed"  data-topbar="light"{% endblock html %}
{% block title %}參數管理{% endblock title %}

{% block extra_css %}
    <!--datatable css-->
    <link href="{% static 'libs/datatable/css/dataTables.bootstrap5.min.css' %}" rel="stylesheet"/>

    <!--datatable button css-->
    <link href="{% static 'libs/datatable/css/buttons.dataTables.min.css' %}" rel="stylesheet"/>

    <!--datatable responsive css-->
    <link href="{% static 'libs/datatable/css/responsive.bootstrap.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'libs/datatable/css/dataTables.dataTables.css' %}" rel="stylesheet"/>

    <!-- SweetAlert2 css-->
    <link href="{% static 'libs/sweetalert2/dist/sweetalert2.min.css' %}" rel="stylesheet">

    <!-- icon css -->
    <link href="{% static 'iconfonts/fontawesome/fontawesome-all.min.css' %}" rel="stylesheet" type="text/css"/>


{% endblock extra_css %}

{% block content %}
    <div class="main-content">
        <div class="page-content">
            <div class="container-fluid">
                {% block pagetitle %}
                    {% include "partials/page-title.html" with pagetitle="後台管理" title="參數管理" %}
                {% endblock pagetitle %}
                <!-- Row -->
                <div class="row row-sm">
                    <div class="col-lg-12">
                        <div class="card custom-card">
                            <div class="card-body">
                                <div class="mb-3">
                                    <button type="button" class="btn btn-primary" id="new" data-bs-toggle="modal"
                                                    data-bs-target="#NewAndEditModal" title="新增"><i class="ri-add-line"></i> 新增</button>
                                    <button type="button" class="btn btn-info" id="copy" title="請先選擇要複製的那一筆">
                                        <i class="fas fa-copy"></i> 複製所選
                                    </button>
                                </div>
                                <div class="table-responsive ">
                                    <table id="datatable" class="table table-bordered dt-responsive nowrap table-striped align-middle hover" style="width:100%">
                                        <thead>
                                        <tr>
                                            <th scope="col">參數類別</th>
                                            <th scope="col">參數鍵</th>
                                            <th scope="col">參數值</th>
                                            <th scope="col">排序</th>
                                            <th scope="col">備註</th>
                                            <th scope="col">動作</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Row -->

                <!-- NEW and EDIT Modal -->
                <div class="modal fade" id="NewAndEditModal" role="dialog">
                    {% csrf_token %}
                    <div class="modal-dialog">
                        <!-- Modal content-->
                        <div class="modal-content">
                            <form class="form-group" role="form">
                                <div class="modal-header">
                                    <h3 class="modal-title" id="modal_title"></h3>
                                    <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button">
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="row g-3">
                                        <div class="col-md-12 form-group">
                                            <label for="pa_type">參數類別</label><span class="text-danger ml-1"
                                                                                       style="color:red"> *</span>
                                            <input type="text" class="form-control" id="pa_type" name="pa_type"
                                                   placeholder="參數類別" required>
                                        </div>
                                        <div class="col-md-12 form-group">
                                            <label for="pa_key">參數鍵</label><span class="text-danger ml-1" style="color:red"> *</span>
                                            <input type="text" class="form-control" id="pa_key" name="pa_key" placeholder="參數鍵" required>
                                        </div>
                                        <div class="col-md-12 form-group">
                                            <label for="pa_value">參數值</label><span class="text-danger ml-1" style="color:red"> *</span>
                                            <input type="text" class="form-control" id="pa_value" name="pa_value" placeholder="參數值" required>
                                        </div>
                                        <div class="col-md-12 form-group">
                                            <label for="pa_sort">排序</label><span class="text-danger ml-1"
                                                                                   style="color:red"> *</span>
                                            <input type="number" class="form-control" id="pa_sort" name="pa_sort"
                                                   placeholder="排序" required>
                                        </div>
                                        <div class="col-md-12 form-group">
                                            <label for="pa_comment">備註</label>
                                            <input type="text" class="form-control" id="pa_comment" name="pa_comment" placeholder="備註">
                                        </div>
                                    </div>
                                    <input type="hidden" id="type" name="type" value="">
                                    <input type="hidden" id="create_user" name="create_user" value="{{ username }}">
                                    <input type="hidden" id="last_modified_user" name="last_modified_user" value="{{ username }}">
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn ripple btn-primary"><i class="bx bx-save"></i> 存檔</button>
                                    <button class="btn ripple btn-light" data-bs-dismiss="modal" type="button"><i class="ri-close-line"></i> 取消</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Delete Modal -->
                <div class="modal fade" id="DeleteModal" role="dialog">
                    <div class="modal-dialog">
                        <!-- Modal content-->
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title"><i class="fa fa-trash-alt modal-icon text-danger"> 刪除</i></h4>
                                <small class="modal-subtitle"></small>
                                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                            </div>
                            <div class="modal-body">
                                <p class="lead">你確認要刪除: <strong id="delid"></strong>?</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn ripple btn-danger" data-dismiss="modal" id="delete"><i class="bx bx-trash"></i> 刪除</button>
                                <button type="button" class="btn ripple btn-light" data-bs-dismiss="modal"><i class="ri-close-line"></i> 取消</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Page-content -->
        </div>
    </div>
{% endblock content %}

{% block extra_js %}
    <!-- jquery -->
    <script src="{% static 'libs/jquery/jquery-3.6.0.min.js' %}"></script>

    <!--  Datatable js -->
    <script src="{% static 'libs/datatable/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'libs/datatable/js/dataTables.bootstrap5.min.js' %}"></script>
    <script src="{% static 'libs/datatable/js/dataTables.buttons.min.js' %}"></script>
    <script src="{% static 'libs/datatable/js/dataTables.responsive.min.js' %}"></script>

    <!-- sweetalert2 js-->
    <script src="{% static 'libs/sweetalert2/dist/sweetalert2.all.min.js' %}"></script>
    <script src="{% static 'js/inits/sweetalert2.init.js' %}"></script>

    <!-- datatable init -->
    <script>
        let baseUrl = '/commons/parameter/';

        let table = $('#datatable').DataTable({
            'processing': true,
            'serverSide': true,
            'language': {url: '{% static 'libs/datatable/zh-HANT.json' %}'},
            'order': [[0, 'asc'], [3, 'asc']],
            'ajax': {
                url: baseUrl,
                type: 'GET',
            },
            'columns': [
                {"data": "pa_type"},
                {"data": "pa_key"},
                {"data": "pa_value"},
                {"data": "pa_sort"},
                {"data": "pa_comment"},
                {
                    "data": null,
                    "orderable": false,
                    "defaultContent":
                        '<div class="dropdown d-inline-block">' +
                        '<button class="btn btn-soft-secondary btn-sm dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">' +
                        '<i class="ri-more-fill align-middle"></i> ' +
                        '</button> ' +
                        '<ul class="dropdown-menu dropdown-menu-end">' +
                        '<li class="dropdown-item edit-item-btn" data-bs-toggle="modal" data-bs-target="#NewAndEditModal" title="修改"><i class="ri-pencil-fill align-bottom me-2 text-muted"></i> 修改</li> ' +
                        '<li class="dropdown-item remove-item-btn" data-bs-toggle="modal" data-bs-target="#DeleteModal" title="刪除"><i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i> 刪除</li> ' +
                        '</ul>' +
                        '</div>'
                }
            ],
        });
    </script>

    <!-- CRUD -->
    <script>
        let id = 0;

        $(document).ready(function () {
            // 點選修改或刪除
            $('#datatable tbody').on('click', '.edit-item-btn, .remove-item-btn', function () {
                let data = table.row($(this).parents('tr')).data();
                if (data === undefined) {
                    let datanum = table.row($(this))['0'][0];
                    data = table.row($(this).parents('tr')).context[0].aoData[datanum]._aData;
                }
                id = data['id'];

                if ($(this).hasClass('edit-item-btn')) {
                    // 修改
                    $('#pa_type').val(data['pa_type']);
                    $('#pa_key').val(data['pa_key']);
                    $('#pa_value').val(data['pa_value']);
                    $('#pa_sort').val(data['pa_sort']);
                    $('#pa_comment').val(data['pa_comment']);
                    $('#type').val('EDIT');
                    $('#modal_title').html('<i class="fas fa-edit modal-icon text-info"> 修改</i>');
                } else {
                    // 刪除
                    $('#delid').text(data['pa_type']);
                }
            });

            // 新增或修改存檔
            $('form').on('submit', function (e) {
                e.preventDefault();
                let url = baseUrl;
                let method = $('#type').val() === 'NEW' ? 'POST' : 'PUT';
                if (method === 'PUT') url += id + '/';

                $.ajax({
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    url: url,
                    method: method,
                    data: $(this).serialize(),
                    success: function () {
                        table.ajax.reload(null, false);
                        $("#NewAndEditModal").modal('hide');
                        Toast.fire({icon: 'success', title: '存檔成功'});
                    },
                    error: function (jqXHR) {
                        let errorMessage = jqXHR.responseJSON;
                        Toast.fire({icon: 'error', title: errorMessage});
                        console.log(jqXHR);
                    }
                });
            });

            // 刪除
            $('#DeleteModal').on('click', '#delete', function () {
                $.ajax({
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    url: baseUrl + id + '/',
                    method: 'DELETE',
                    success: function () {
                        table.ajax.reload(null, false);
                        $("#DeleteModal").modal('hide');
                        Toast.fire({icon: 'success', title: '刪除成功'});
                    },
                    error: function (jqXHR) {
                        Toast.fire({icon: 'error', title: '刪除失敗'});
                        console.log(jqXHR);
                    }
                });
            });

            // 新增
            $('#new').on('click', function () {
                $('#pa_type, #pa_key, #pa_value, #pa_sort, #pa_comment').val('');
                $('#type').val('NEW');
                $('#modal_title').html('<i class="fa fa-plus modal-icon text-primary"> 新增</i>');
            });

            // 複製
            $('#datatable tbody').on( 'click', 'tr', function () {
                if ( $(this).hasClass('selected') ) {
                    $(this).removeClass('selected');
                }
                else {
                    table.$('tr.selected').removeClass('selected');
                    $(this).addClass('selected');
                }
            } );

            $('#copy').on('click', function (e) {
                if (table.row('.selected').any() == false) { alert('請選擇一筆資料'); }
                let data = table.row('.selected').data();
                $('#pa_type').val(data['pa_type']);
                $('#pa_key').val(data['pa_key']);
                $('#pa_value').val(data['pa_value']);
                $('#pa_sort').val(data['pa_sort']);
                $('#pa_comment').val(data['pa_comment']);
                $('#type').val('NEW');
                $('#modal_title').html(`<i class="ri-file-copy-line modal-icon copy-text-modal-title"> 複製</i>`);
                $("#NewAndEditModal").modal('show');
            } );

        });
    </script>
{% endblock extra_js %}